<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardDraw8 ‚Äì Random Luck</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CardDraw8">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXJfMV8xIiB4MT0iMCIgeTE9IjAiIHgyPSIxOTIiIHkyPSIxOTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzdjM2FlZCIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMzYjgyZjYiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8dGV4dCB4PSI5NiIgeT0iMTEwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+PoTwvdGV4dD4KPHRleHQgeD0iOTYiIHk9IjE0MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNhcmREcmF3ODwvdGV4dD4KPC9zdmc+">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for themes */
        :root {
            --bg-primary: #1e1b4b;
            --bg-secondary: rgba(0, 0, 0, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #c4b5fd;
            --accent-primary: #8b5cf6;
            --accent-secondary: #3b82f6;
        }

        /* Dark theme (default) */
        [data-theme="dark"] {
            --bg-primary: #1e1b4b;
            --bg-secondary: rgba(0, 0, 0, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #c4b5fd;
            --accent-primary: #8b5cf6;
            --accent-secondary: #3b82f6;
        }

        /* Light theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: rgba(255, 255, 255, 0.7);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-primary: #8b5cf6;
            --accent-secondary: #3b82f6;
        }

        [data-theme="light"] body {
            background: linear-gradient(to bottom right, #e0e7ff, #f3e8ff, #fce7f3) !important;
            color: var(--text-primary) !important;
        }

        /* Mystical theme */
        [data-theme="mystical"] {
            --bg-primary: #0f0f23;
            --bg-secondary: rgba(75, 0, 130, 0.3);
            --text-primary: #ffd700;
            --text-secondary: #dda0dd;
            --accent-primary: #ff6347;
            --accent-secondary: #ffd700;
        }

        [data-theme="mystical"] body {
            background: linear-gradient(to bottom right, #0f0f23, #4b0082, #2e0a47) !important;
            color: var(--text-primary) !important;
        }

        /* Apply theme variables to elements */
        .bg-black\/30 {
            background-color: var(--bg-secondary) !important;
        }

        .text-purple-200 {
            color: var(--text-secondary) !important;
        }

        body { font-family: 'Inter', sans-serif; }
        
        .card-container {
            width: 140px;
            height: 196px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            animation: sparkle 2s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .oracle-orb {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffd700, #ffb347, #ff8c00);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
        }
        
        .pip {
            font-size: 16px;
            line-height: 1;
            position: absolute;
        }
        
        .pip.red { color: #dc2626; }
        .pip.black { color: #1f2937; }
        
        .card-content {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 8px;
        }
        
        .corner-pip {
            font-size: 14px;
            font-weight: bold;
        }
        
        .corner-pip.top-left {
            position: absolute;
            top: 6px;
            left: 6px;
            text-align: center;
            line-height: 1;
        }
        
        .corner-pip.bottom-right {
            position: absolute;
            bottom: 6px;
            right: 6px;
            text-align: center;
            line-height: 1;
            transform: rotate(180deg);
        }
        
        .draggable {
            cursor: move;
            transition: transform 0.2s;
        }
        
        .draggable:hover {
            transform: scale(1.05);
        }
        
        .drag-over {
            background-color: rgba(139, 92, 246, 0.2);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body data-theme="dark" class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <div></div> <!-- Spacer for centering -->
                <h1 class="text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    CardDraw8 ‚Äì Random Luck
                </h1>
                <button onclick="toggleTheme()" aria-label="Switch between dark, light, and mystical themes" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-sm">
                    üé® Theme
                </button>
            </div>
            <p class="text-purple-200">Mystical lottery experience with cryptographic randomness</p>
        </div>

        <!-- Suit Order Configuration -->
        <div class="bg-black/30 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üîÆ Mystical Suit Alignment</h2>
            <div class="flex flex-wrap gap-4 mb-4 justify-center">
                <button onclick="setSuitOrder('classic')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                    Classic Order
                </button>
                <button onclick="setSuitOrder('reverse')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                    Reverse Order
                </button>
                <button onclick="setSuitOrder('custom')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                    Custom Order
                </button>
            </div>
            <div id="suitOrder" class="flex gap-4 justify-center">
                <!-- Suit order will be populated by JavaScript -->
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Card Draw Section -->
            <div class="bg-black/30 rounded-xl p-6">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-semibold mb-4">üÉè Card Draw</h2>
                    <div class="flex gap-2 justify-center">
                        <button onclick="drawCards()" aria-label="Draw 6 mystical cards to generate lottery numbers" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-lg transition-all transform hover:scale-105">
                            Draw 6 Cards
                        </button>
                        <button onclick="runSimulation()" aria-label="Run Monte Carlo simulation with 500 card draws" class="px-6 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 rounded-lg transition-all transform hover:scale-105">
                            Run Simulation
                        </button>
                    </div>
                </div>
                
                <div id="cardArea" class="grid grid-cols-3 gap-4 mb-6 place-items-center">
                    <!-- Cards will be populated by JavaScript -->
                </div>
                
                <!-- Simulation Progress -->
                <div id="simulationProgress" class="hidden mb-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span>Monte Carlo Simulation</span>
                        <span id="progressText">0/500</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="progressBar" class="progress-bar bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Oracle & Results Section -->
            <div class="bg-black/30 rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-6">üîÆ Digital Root Oracle</h2>
                
                <div class="flex flex-col items-center mb-6">
                    <div id="oracleOrb" class="oracle-orb flex items-center justify-center text-2xl font-bold text-black mb-4">
                        ?
                    </div>
                    <div id="oracleSteps" class="text-center text-sm text-purple-200">
                        Draw cards to reveal your mystical number
                    </div>
                    <div id="numerologyMeaning"></div>
                </div>

                <!-- Powerball Numbers -->
                <div id="powerballs" class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">üéü NZ Powerball Numbers</h3>
                    <div class="grid grid-cols-6 gap-2 mb-2">
                        <div class="text-center text-xs text-purple-200">Main Numbers</div>
                        <div class="col-span-4"></div>
                        <div class="text-center text-xs text-purple-200">Powerball</div>
                    </div>
                    <div id="powerballs-numbers" class="grid grid-cols-6 gap-2">
                        <!-- Numbers will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Export Options -->
                <div class="flex gap-2">
                    <button onclick="exportTicket()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors text-sm">
                        Export Ticket
                    </button>
                    <button onclick="exportHistory()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors text-sm">
                        Export History
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="bg-black/30 rounded-xl p-6 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üìä Mystical Statistics - Recent Draw History</h2>
                <button onclick="clearHistory()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm">
                    Clear History
                </button>
            </div>
            <div class="overflow-x-auto">
                <div id="drawHistory" class="text-sm text-purple-200">
                    No draws yet
                </div>
            </div>
        </div>
    </div>

    <script>
        // Numerology meanings for digital roots
        const numerologyMeanings = {
            1: "New Beginnings - Leadership, independence, and pioneering spirit. A time to start fresh.",
            2: "Cooperation - Partnership, diplomacy, and balance. Seek harmony in relationships.",
            3: "Creativity - Artistic expression, communication, and joy. Let your creative spirit shine.",
            4: "Stability - Hard work, organization, and building foundations. Focus on practical matters.",
            5: "Freedom - Adventure, change, and versatility. Embrace new experiences and opportunities.",
            6: "Nurturing - Family, home, and responsibility. Care for others and create harmony.",
            7: "Spirituality - Introspection, wisdom, and mystical insights. Trust your inner knowing.",
            8: "Material Success - Ambition, business acumen, and achievement. Focus on material goals.",
            9: "Completion - Humanitarianism, wisdom, and endings. Share your gifts with the world."
        };

        // Global state management
        const gameState = {
            currentDraw: [],
            history: JSON.parse(localStorage.getItem('cardDraw8History') || '[]'),
            suitOrder: JSON.parse(localStorage.getItem('cardDraw8SuitOrder') || '["‚ô•", "‚ô¶", "‚ô†", "‚ô£"]'),
            stats: JSON.parse(localStorage.getItem('cardDraw8Stats') || '{"cardFrequency": {}, "rootDistribution": {}}')
        };

        // Tarot suit mappings
        const tarotSuits = {
            '‚ô•': 'Cups',
            '‚ô¶': 'Pentacles', 
            '‚ô†': 'Swords',
            '‚ô£': 'Wands'
        };

        // Display numerology meaning for digital root
        function showNumerology(root) {
            const meaning = numerologyMeanings[root];
            if (meaning) {
                const numerologyDiv = document.getElementById('numerologyMeaning');
                if (numerologyDiv) {
                    numerologyDiv.innerHTML = `
                        <div class="mt-4 p-4 bg-yellow-900/30 rounded-lg border border-yellow-600/50">
                            <h4 class="text-lg font-semibold text-yellow-400 mb-2">‚ú® Numerological Meaning</h4>
                            <p class="text-yellow-200 text-sm">${meaning}</p>
                        </div>
                    `;
                }
            }
        }

        // Theme switcher function
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme') || 'dark';
            const themes = ['dark', 'light', 'mystical'];
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const nextTheme = themes[nextIndex];
            
            body.setAttribute('data-theme', nextTheme);
            localStorage.setItem('cardDraw8Theme', nextTheme);
        }

        // Cryptographically secure random number generator
        function secureRandom(max) {
            const array = new Uint32Array(1);
            crypto.getRandomValues(array);
            return array[0] % max;
        }

        // Generate realistic playing card faces using provided code
        function generateCardFace(value, suit) {
            const isRed = suit === '‚ô•' || suit === '‚ô¶';
            const color = isRed ? '#dc2626' : '#1f2937';
            
            // Convert suit symbols to match the provided code format
            const suitMap = {
                '‚ô†': 'spades',
                '‚ô•': 'hearts', 
                '‚ô¶': 'diamonds',
                '‚ô£': 'clubs'
            };
            
            const suitName = suitMap[suit];
            const rank = value === 1 ? 'A' : value.toString();
            
            return `
                <svg width="100%" height="100%" viewBox="0 0 169 245" style="position: absolute; top: 0; left: 0;">
                    <rect width="169" height="245" rx="12" ry="12" fill="white" stroke="#000" stroke-width="1"/>
                    ${generateCardContent(rank, suitName, color)}
                </svg>
            `;
        }

        function generateCardContent(rank, suit, color) {
            const suitSymbols = {
                'spades': '‚ô†',
                'hearts': '‚ô•',
                'diamonds': '‚ô¶',
                'clubs': '‚ô£'
            };
            
            const symbol = suitSymbols[suit];
            
            // Corner indices
            let content = `
                <!-- Top left corner -->
                <text x="15" y="20" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="${color}">${rank}</text>
                <text x="15" y="35" font-family="Arial, sans-serif" font-size="14" fill="${color}">${symbol}</text>
                
                <!-- Bottom right corner (rotated) -->
                <g transform="rotate(180 84.5 122.5)">
                    <text x="15" y="20" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="${color}">${rank}</text>
                    <text x="15" y="35" font-family="Arial, sans-serif" font-size="14" fill="${color}">${symbol}</text>
                </g>
            `;
            
            // Generate pip pattern based on rank
            content += generatePipPattern(rank, suit, symbol, color);
            
            return content;
        }

        function generatePipPattern(rank, suit, symbol, color) {
            const fontSize = 24;
            let pips = '';
            
            switch(rank) {
                case 'A':
                    pips = `<text x="84.5" y="135" font-family="Arial, sans-serif" font-size="36" fill="${color}" text-anchor="middle">${symbol}</text>`;
                    break;
                    
                case '2':
                    pips = `
                        <text x="84.5" y="80" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="84.5" y="80" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '3':
                    pips = `
                        <text x="84.5" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="84.5" y="135" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="84.5" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '4':
                    pips = `
                        <text x="60" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '5':
                    pips = `
                        <text x="60" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="84.5" y="135" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '6':
                    pips = `
                        <text x="60" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="60" y="135" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="135" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="75" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '7':
                    pips = `
                        <text x="60" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="60" y="110" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="110" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="84.5" y="90" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '8':
                    pips = `
                        <text x="60" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="60" y="105" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="105" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="84.5" y="87" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="70" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="84.5" y="87" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '9':
                    pips = `
                        <text x="60" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="60" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="84.5" y="135" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="60" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
                    
                case '10':
                    pips = `
                        <text x="60" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="60" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="109" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <text x="84.5" y="80" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        <g transform="rotate(180 84.5 122.5)">
                            <text x="60" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="65" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="60" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="109" y="95" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                            <text x="84.5" y="80" font-family="Arial, sans-serif" font-size="${fontSize}" fill="${color}" text-anchor="middle">${symbol}</text>
                        </g>
                    `;
                    break;
            }
            
            return pips;
        }

        // Create 40-card deck (Ace-10, 4 suits)
        function createDeck() {
            const deck = [];
            for (let suit of gameState.suitOrder) {
                for (let value = 1; value <= 10; value++) {
                    deck.push({ suit, value });
                }
            }
            return deck;
        }

        // Calculate codex value based on suit position and card value
        function calculateCodex(card) {
            const suitPosition = gameState.suitOrder.indexOf(card.suit) + 1;
            return (suitPosition * 10) + card.value;
        }

        // Calculate digital root with step-by-step animation
        function calculateDigitalRoot(sum) {
            const steps = [];
            let current = sum;
            
            while (current >= 10) {
                steps.push(current);
                current = current.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
            }
            steps.push(current);
            
            return { root: current, steps };
        }

        // Animate digital root calculation
        function animateDigitalRoot(sum) {
            const { root, steps } = calculateDigitalRoot(sum);
            const oracleOrb = document.getElementById('oracleOrb');
            const oracleSteps = document.getElementById('oracleSteps');
            
            let stepIndex = 0;
            
            function showNextStep() {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    oracleOrb.textContent = step;
                    
                    if (stepIndex === 0) {
                        oracleSteps.textContent = `Sum: ${step}`;
                    } else if (stepIndex === steps.length - 1) {
                        oracleSteps.textContent = `Digital Root: ${step}`;
                        // Show numerology meaning after final step
                        setTimeout(() => showNumerology(step), 500);
                    } else {
                        const digits = step.toString().split('').join(' + ');
                        oracleSteps.textContent = `${digits} = ${steps[stepIndex + 1]}`;
                    }
                    
                    stepIndex++;
                    setTimeout(showNextStep, 1000);
                }
            }
            
            showNextStep();
            return root;
        }

        // Draw 6 cards with animation
        function drawCards() {
            const deck = createDeck();
            const drawn = [];
            
            // Shuffle and draw 6 cards
            for (let i = 0; i < 6; i++) {
                const randomIndex = secureRandom(deck.length);
                drawn.push(deck.splice(randomIndex, 1)[0]);
            }
            
            gameState.currentDraw = drawn;
            displayCards(drawn);
            
            // Calculate results immediately
            const sum = drawn.reduce((acc, card) => acc + calculateCodex(card), 0);
            const digitalRoot = animateDigitalRoot(sum);
            generatePowerballNumbers(drawn, digitalRoot);
            
            // Save to history
            const drawData = {
                timestamp: new Date().toISOString(),
                cards: drawn,
                sum,
                digitalRoot,
                type: 'manual'
            };
            
            gameState.history.push(drawData);
            updateStats(drawData);
            saveGameState();
            updateDisplay();
        }

        // Display cards directly
        function displayCards(cards) {
            const cardArea = document.getElementById('cardArea');
            cardArea.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                cardArea.appendChild(cardElement);
            });
        }

        // Create individual card element
        function createCardElement(card, index) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card-container';
            
            const codex = calculateCodex(card);
            const tarotName = `${card.value} of ${tarotSuits[card.suit]}`;
            const cardFace = generateCardFace(card.value, card.suit);
            
            cardDiv.innerHTML = `
                ${cardFace}
                <!-- Tarot info overlay at bottom -->
                <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; text-center; z-index: 10;">
                    <div style="background: rgba(255,255,255,0.9); border-radius: 4px; padding: 2px 4px; font-size: 10px; color: #666; margin-bottom: 2px;">${tarotName}</div>
                    <div style="background: rgba(139, 92, 246, 0.9); border-radius: 4px; padding: 2px 4px; font-size: 10px; color: white;">Codex: ${codex}</div>
                </div>
            `;
            
            return cardDiv;
        }

        // Generate NZ Powerball numbers from cards
        function generatePowerballNumbers(cards, powerball) {
            const numbers = cards.map(card => {
                const codex = calculateCodex(card);
                return ((codex - 1) % 40) + 1; // Ensure 1-40 range
            }).sort((a, b) => a - b);
            
            displayPowerballNumbers(numbers, powerball);
        }

        // Display Powerball numbers
        function displayPowerballNumbers(numbers, powerball) {
            const container = document.getElementById('powerballs-numbers');
            container.innerHTML = '';
            
            // Main numbers
            numbers.forEach(num => {
                const numDiv = document.createElement('div');
                numDiv.className = 'w-10 h-10 bg-white text-black rounded-full flex items-center justify-center font-bold text-sm';
                numDiv.textContent = num;
                container.appendChild(numDiv);
            });
            
            // Powerball number
            const powDiv = document.createElement('div');
            powDiv.className = 'w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center font-bold text-sm';
            powDiv.textContent = powerball;
            container.appendChild(powDiv);
        }

        // Run Monte Carlo simulation
        async function runSimulation() {
            const progressDiv = document.getElementById('simulationProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.classList.remove('hidden');
            
            // Track card frequency for this simulation batch
            const batchCardFreq = {};
            let bestDraw = null;
            let bestSum = 0;
            
            for (let i = 0; i < 500; i++) {
                // Simulate a draw
                const deck = createDeck();
                const drawn = [];
                
                for (let j = 0; j < 6; j++) {
                    const randomIndex = secureRandom(deck.length);
                    drawn.push(deck.splice(randomIndex, 1)[0]);
                }
                
                const sum = drawn.reduce((acc, card) => acc + calculateCodex(card), 0);
                const { root } = calculateDigitalRoot(sum);
                
                // Track card frequency for this batch
                drawn.forEach(card => {
                    const cardKey = `${card.value}${card.suit}`;
                    batchCardFreq[cardKey] = (batchCardFreq[cardKey] || 0) + 1;
                    // Update global stats
                    gameState.stats.cardFrequency[cardKey] = (gameState.stats.cardFrequency[cardKey] || 0) + 1;
                });
                
                // Update global root distribution
                gameState.stats.rootDistribution[root] = (gameState.stats.rootDistribution[root] || 0) + 1;
                
                // Keep track of the draw with highest sum (most significant)
                if (sum > bestSum) {
                    bestSum = sum;
                    bestDraw = {
                        timestamp: new Date().toISOString(),
                        cards: drawn,
                        sum,
                        digitalRoot: root,
                        type: 'simulation',
                        batchNumber: gameState.history.filter(h => h.type === 'simulation' && h.batchNumber).length + 1
                    };
                }
                
                // Update progress
                const progress = ((i + 1) / 500) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${i + 1}/500`;
                
                // Allow UI to update
                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            // Only add the best draw from this simulation batch to history
            if (bestDraw) {
                bestDraw.batchNumber = gameState.history.filter(h => h.type === 'simulation' && h.batchNumber).length + 1;
                gameState.history.push(bestDraw);
            }
            
            saveGameState();
            updateDisplay();
            
            setTimeout(() => {
                progressDiv.classList.add('hidden');
            }, 2000);
        }

        // Update statistics
        function updateStats(drawData) {
            drawData.cards.forEach(card => {
                const cardKey = `${card.value}${card.suit}`;
                gameState.stats.cardFrequency[cardKey] = (gameState.stats.cardFrequency[cardKey] || 0) + 1;
            });
            
            gameState.stats.rootDistribution[drawData.digitalRoot] = 
                (gameState.stats.rootDistribution[drawData.digitalRoot] || 0) + 1;
        }

        // Update display elements
        function updateDisplay() {
            updateDrawHistory();
        }

        // Update draw history display with detailed information
        function updateDrawHistory() {
            const container = document.getElementById('drawHistory');
            const recent = gameState.history.slice(-20).reverse(); // Show last 20 draws
            
            if (recent.length === 0) {
                container.textContent = 'No draws yet';
                return;
            }
            
            // Create table header
            let html = `
                <div class="grid grid-cols-12 gap-2 mb-3 font-semibold text-purple-100 border-b border-purple-400 pb-2">
                    <div class="col-span-1">#</div>
                    <div class="col-span-1">Type</div>
                    <div class="col-span-3">Date & Time</div>
                    <div class="col-span-6">NZ Powerball Numbers</div>
                    <div class="col-span-1">Root</div>
                </div>
            `;
            
            // Add each draw
            recent.forEach((draw, index) => {
                const drawNumber = draw.type === 'simulation' && draw.batchNumber ? 
                    `Sim ${draw.batchNumber}` : 
                    gameState.history.length - index;
                const date = new Date(draw.timestamp).toLocaleString();
                const type = draw.type === 'simulation' ? 'ü§ñ' : 'üéØ';
                
                // Calculate powerball numbers from cards
                const powerballs = draw.cards.map(card => {
                    const codex = calculateCodex(card);
                    return ((codex - 1) % 40) + 1;
                }).sort((a, b) => a - b);
                
                // Format powerball numbers
                const numbersHtml = powerballs.map(num => 
                    `<span class="inline-block w-6 h-6 bg-white text-black rounded-full text-center text-xs leading-6 mr-1">${num}</span>`
                ).join('');
                
                const rootHtml = `<span class="inline-block w-6 h-6 bg-red-500 text-white rounded-full text-center text-xs leading-6">${draw.digitalRoot}</span>`;
                
                html += `
                    <div class="grid grid-cols-12 gap-2 mb-2 py-1 hover:bg-purple-800/20 rounded">
                        <div class="col-span-1 text-xs">${drawNumber}</div>
                        <div class="col-span-1 text-xs">${type}</div>
                        <div class="col-span-3 text-xs">${date}</div>
                        <div class="col-span-6 text-xs">${numbersHtml}</div>
                        <div class="col-span-1 text-xs">${rootHtml}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Suit order management
        function setSuitOrder(type) {
            switch(type) {
                case 'classic':
                    gameState.suitOrder = ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'];
                    break;
                case 'reverse':
                    gameState.suitOrder = ['‚ô£', '‚ô†', '‚ô¶', '‚ô•'];
                    break;
                case 'custom':
                    // Enable drag and drop
                    break;
            }
            
            displaySuitOrder();
            saveGameState();
        }

        // Display suit order with drag and drop
        function displaySuitOrder() {
            const container = document.getElementById('suitOrder');
            container.innerHTML = '';
            
            gameState.suitOrder.forEach((suit, index) => {
                const suitDiv = document.createElement('div');
                suitDiv.className = 'draggable bg-purple-600 hover:bg-purple-700 rounded-lg p-4 text-center cursor-move';
                suitDiv.draggable = true;
                suitDiv.dataset.suit = suit;
                suitDiv.innerHTML = `
                    <div class="text-2xl mb-1">${suit}</div>
                    <div class="text-xs">${tarotSuits[suit]}</div>
                    <div class="text-xs text-purple-200">Position ${index + 1}</div>
                `;
                
                // Drag and drop event listeners
                suitDiv.addEventListener('dragstart', handleDragStart);
                suitDiv.addEventListener('dragover', handleDragOver);
                suitDiv.addEventListener('drop', handleDrop);
                suitDiv.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(suitDiv);
            });
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedElement !== this) {
                const draggedSuit = draggedElement.dataset.suit;
                const targetSuit = this.dataset.suit;
                
                const draggedIndex = gameState.suitOrder.indexOf(draggedSuit);
                const targetIndex = gameState.suitOrder.indexOf(targetSuit);
                
                // Swap positions
                gameState.suitOrder[draggedIndex] = targetSuit;
                gameState.suitOrder[targetIndex] = draggedSuit;
                
                displaySuitOrder();
                saveGameState();
            }
        }

        function handleDragEnd(e) {
            this.style.opacity = '';
            document.querySelectorAll('.draggable').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        // Export functions
        function exportTicket() {
            if (gameState.currentDraw.length === 0) {
                alert('Draw cards first to generate a ticket!');
                return;
            }
            
            const lastDraw = gameState.history[gameState.history.length - 1];
            const ticket = {
                timestamp: lastDraw.timestamp,
                cards: lastDraw.cards,
                numbers: lastDraw.cards.map(card => ((calculateCodex(card) - 1) % 40) + 1).sort((a, b) => a - b),
                powerball: lastDraw.digitalRoot,
                codexSum: lastDraw.sum
            };
            
            downloadJSON(ticket, `cardDraw8-ticket-${Date.now()}.json`);
        }

        function exportHistory() {
            const exportData = {
                history: gameState.history,
                stats: gameState.stats,
                suitOrder: gameState.suitOrder,
                exportDate: new Date().toISOString()
            };
            
            downloadJSON(exportData, `cardDraw8-history-${Date.now()}.json`);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Clear history function
        function clearHistory() {
            if (confirm('Are you sure you want to clear all draw history? This action cannot be undone.')) {
                gameState.history = [];
                gameState.stats = { cardFrequency: {}, rootDistribution: {} };
                saveGameState();
                updateDisplay();
                
                // Reset oracle display
                document.getElementById('oracleOrb').textContent = '?';
                document.getElementById('oracleSteps').textContent = 'Draw cards to reveal your mystical number';
                
                // Clear numerology meaning
                const numerologyDiv = document.getElementById('numerologyMeaning');
                if (numerologyDiv) {
                    numerologyDiv.innerHTML = '';
                }
                
                // Clear powerball numbers
                document.getElementById('powerballs-numbers').innerHTML = '';
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            localStorage.setItem('cardDraw8History', JSON.stringify(gameState.history));
            localStorage.setItem('cardDraw8Stats', JSON.stringify(gameState.stats));
            localStorage.setItem('cardDraw8SuitOrder', JSON.stringify(gameState.suitOrder));
        }

        // Initialize the application
        function init() {
            // Load saved theme
            const savedTheme = localStorage.getItem('cardDraw8Theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            displaySuitOrder();
            updateDisplay();
            
            // Initialize card area
            const cardArea = document.getElementById('cardArea');
            for (let i = 0; i < 6; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'w-35 h-49 bg-gray-700/50 rounded-xl border-2 border-dashed border-gray-500 flex items-center justify-center text-gray-400 text-sm';
                placeholder.textContent = 'Card ' + (i + 1);
                cardArea.appendChild(placeholder);
            }
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          document.getElementById('installBtn').style.display = 'block';
        });
        
        document.getElementById('installBtn').addEventListener('click', () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(choice => {
              if (choice.outcome === 'accepted') {
                console.log('User accepted the install prompt');
              }
              deferredPrompt = null;
            });
          }
        });
        // Start the application
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9790d14556d61c5e',t:'MTc1Njg1NjA2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

